#!/usr/bin/env php
<?php

declare(strict_types=1);

use B24\Center\Core\Application;
use B24\Center\Modules\Hauls\Infrastructure\DriverAccountRepository;
use DateTimeImmutable;

$rootPath = dirname(__DIR__);
$autoloadPath = $rootPath . '/vendor/autoload.php';

if (!file_exists($autoloadPath)) {
    fwrite(STDERR, "Composer autoload not found. Run `composer install`.\n");
    exit(1);
}

require $autoloadPath;

$configPath = $rootPath . '/config/driver_accounts.php';

if (!file_exists($configPath)) {
    fwrite(STDERR, "Config file config/driver_accounts.php not found.\n");
    exit(1);
}

$accountsConfig = require $configPath;

if (!is_array($accountsConfig)) {
    fwrite(STDERR, "Config file must return array of driver accounts.\n");
    exit(1);
}

/** @var Application $container */
$container = require $rootPath . '/bootstrap/app.php';

/** @var DriverAccountRepository $repository */
$repository = $container->get(DriverAccountRepository::class);

$results = [];
$errors = [];
$synced = 0;
$logEntries = [];

foreach ($accountsConfig as $index => $accountData) {
    if (!is_array($accountData)) {
        $errors[] = sprintf('Запись #%d: ожидался массив.', $index);
        continue;
    }

    $email = isset($accountData['email']) ? strtolower(trim((string) $accountData['email'])) : '';
    $bitrixUserId = isset($accountData['bitrix_user_id']) ? (int) $accountData['bitrix_user_id'] : 0;
    $name = isset($accountData['name']) ? trim((string) $accountData['name']) : '';
    $phone = isset($accountData['phone']) ? trim((string) $accountData['phone']) : null;

    if ($email === '' || !filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errors[] = sprintf('Запись #%d: укажите корректный email.', $index);
        continue;
    }

    if ($bitrixUserId <= 0) {
        $errors[] = sprintf('Запись #%d (%s): укажите bitrix_user_id.', $index, $email);
        continue;
    }

    $plainPassword = null;
    $passwordHash = null;

    if (isset($accountData['password_hash']) && is_string($accountData['password_hash']) && $accountData['password_hash'] !== '') {
        $passwordHash = $accountData['password_hash'];
    } else {
        if (isset($accountData['password']) && is_string($accountData['password']) && $accountData['password'] !== '') {
            $plainPassword = $accountData['password'];
        } else {
            $plainPassword = generatePassword();
        }

        $passwordHash = password_hash($plainPassword, PASSWORD_DEFAULT);
    }

    try {
        $entity = $repository->upsert(
            $bitrixUserId,
            $email,
            $passwordHash,
            $name !== '' ? $name : $email,
            $email,
            $phone !== '' ? $phone : null
        );
    } catch (\Throwable $exception) {
        $errors[] = sprintf('Запись %s: %s', $email, $exception->getMessage());
        continue;
    }

    $synced++;
    $results[] = [
        'email' => $entity->login(),
        'bitrix_user_id' => $entity->bitrixUserId(),
        'name' => $entity->name(),
        'phone' => $entity->phone(),
        'plain_password' => $plainPassword,
    ];

    if ($plainPassword !== null) {
        $logEntries[] = sprintf(
            '[%s] %s (Bitrix ID: %d) — пароль: %s',
            (new DateTimeImmutable())->format('Y-m-d H:i:s'),
            $entity->login(),
            $entity->bitrixUserId(),
            $plainPassword
        );
    }
}

if ($synced === 0 && $errors) {
    fwrite(STDERR, "Не удалось синхронизировать ни одной записи.\n");
} else {
    fwrite(STDOUT, sprintf("Синхронизировано водителей: %d\n", $synced));
}

if ($results) {
    fwrite(STDOUT, str_repeat('-', 60) . PHP_EOL);
    foreach ($results as $item) {
        fwrite(
            STDOUT,
            sprintf(
                "%s (Bitrix ID: %d)%s%s\n",
                $item['email'],
                $item['bitrix_user_id'],
                $item['plain_password'] !== null
                    ? sprintf(" — пароль: %s", $item['plain_password'])
                    : '',
                $item['name'] && $item['name'] !== $item['email']
                    ? sprintf(" (%s)", $item['name'])
                    : ''
            )
        );
    }
}

if ($errors) {
    fwrite(STDERR, str_repeat('-', 60) . PHP_EOL);
    fwrite(STDERR, "Ошибки:\n");
    foreach ($errors as $error) {
        fwrite(STDERR, ' - ' . $error . PHP_EOL);
    }
    exit(1);
}

if ($logEntries) {
    $logDirectory = $rootPath . '/storage/logs';
    if (!is_dir($logDirectory)) {
        mkdir($logDirectory, 0775, true);
    }
    $logPath = $logDirectory . '/driver_passwords.log';
    file_put_contents($logPath, implode(PHP_EOL, $logEntries) . PHP_EOL, FILE_APPEND | LOCK_EX);
}

function generatePassword(int $length = 12): string
{
    $alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%';
    $maxIndex = strlen($alphabet) - 1;
    $password = '';

    for ($i = 0; $i < $length; $i++) {
        $password .= $alphabet[random_int(0, $maxIndex)];
    }

    return $password;
}
