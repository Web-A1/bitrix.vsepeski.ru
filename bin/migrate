#!/usr/bin/env php
<?php

declare(strict_types=1);

use B24\Center\Infrastructure\Persistence\Database\ConnectionFactory;
use B24\Center\Infrastructure\Persistence\Database\Migrator;
use Dotenv\Dotenv;

$rootPath = dirname(__DIR__);

require $rootPath . '/vendor/autoload.php';

if (file_exists($rootPath . '/.env')) {
    Dotenv::createImmutable($rootPath)->safeLoad();
}

if (file_exists($rootPath . '/.env.local')) {
    Dotenv::createImmutable($rootPath, ['.env.local'])->safeLoad();
}

$migrationsPath = $rootPath . '/database/migrations';

try {
    $connection = ConnectionFactory::make();
    $migrator = new Migrator($connection, $migrationsPath);
    $migrator->migrate();
} catch (Throwable $exception) {
    fwrite(STDERR, sprintf("Migration failed: %s\n", $exception->getMessage()));
    exit(255);
}

fwrite(STDOUT, "Migrations executed successfully.\n");
