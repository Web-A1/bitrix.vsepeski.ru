<!DOCTYPE html>
<html lang="ru">
  <head>
    <script src="https://api.bitrix24.com/api/v1/" async></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Рейсы сделки</title>
    <link rel="stylesheet" href="../assets/hauls.css" />
  </head>
  <body>
    <div class="mobile-app" id="mobile-app" hidden data-state="login">
      <section class="mobile-login" id="mobile-login">
        <div class="mobile-login__content">
          <h1>Вход для водителей</h1>
          <p class="mobile-login__hint">
            Введите логин и пароль, выданные диспетчером.
          </p>
          <form id="mobile-login-form" class="mobile-login__form" novalidate>
            <label>
              <span>Логин</span>
              <input type="text" name="login" autocomplete="username" required />
            </label>
            <label>
              <span>Пароль</span>
              <input type="password" name="password" autocomplete="current-password" required />
            </label>
            <p class="mobile-error" id="mobile-login-error" role="alert" aria-live="polite"></p>
            <button type="submit" id="mobile-login-submit" class="button button--primary">
              Войти
            </button>
          </form>
        </div>
      </section>

      <section class="mobile-hauls" id="mobile-hauls" hidden>
        <header class="mobile-hauls__header">
          <p id="mobile-user-name" class="mobile-user"></p>
          <div class="mobile-hauls__actions">
            <button type="button" id="mobile-refresh" class="button button--ghost">
              Обновить
            </button>
          </div>
        </header>
        <p class="mobile-error" id="mobile-hauls-error" role="alert" aria-live="polite" hidden></p>
        <div id="mobile-loader" class="mobile-loader" hidden>Загрузка…</div>
        <div id="mobile-empty" class="mobile-empty" hidden>Активных рейсов нет.</div>
        <ul id="mobile-hauls-list" class="mobile-hauls-list"></ul>
        <footer class="mobile-hauls__footer">
          <button type="button" id="mobile-logout" class="mobile-logout-link">Выйти</button>
        </footer>
      </section>
    </div>

    <div class="mobile-haul-dialog" id="mobile-haul-dialog" hidden aria-hidden="true">
      <div class="mobile-haul-dialog__backdrop" data-mobile-dialog-dismiss></div>
      <section
        class="mobile-haul-dialog__panel"
        role="dialog"
        aria-modal="true"
        aria-labelledby="mobile-haul-dialog-title"
        aria-describedby="mobile-haul-dialog-body"
      >
        <header class="mobile-haul-dialog__header">
          <div>
            <p id="mobile-haul-dialog-title" class="mobile-haul-dialog__title"></p>
            <p id="mobile-haul-dialog-meta" class="mobile-haul-dialog__meta"></p>
          </div>
          <button type="button" class="button button--ghost" id="mobile-haul-dialog-close">Закрыть</button>
        </header>
        <p id="mobile-haul-dialog-error" class="mobile-error mobile-haul-dialog__error" aria-live="polite" hidden></p>
        <div id="mobile-haul-dialog-body" class="mobile-haul-dialog__body"></div>
      </section>
    </div>

    <div class="app-loading" id="app-loading">
      Загружаем данные сделки.<br />
      Ожидайте 3–5 секунд…
    </div>

    <div class="app" id="app" data-view="list" data-initialized="false">
      <header class="app__header">
        <div class="app__title">
          <h1 id="deal-title">Определяем сделку…</h1>
          <p class="deal-meta" id="deal-id-label">Проверяем данные</p>
          <p class="app__subtitle" id="deal-subtitle">
            Загружаем информацию об активности и клиентах.
          </p>
        </div>
        <div class="app__actions">
          <div class="deal-controls" id="deal-controls">
            <label class="deal-controls__field">
              <span>ID сделки</span>
              <input type="number" id="deal-id-input" inputmode="numeric" placeholder="Например 21345" />
            </label>
            <button type="button" id="load-hauls" class="button button--ghost">Загрузить</button>
          </div>
        </div>
      </header>
      <p class="app__error" id="app-error" role="alert" aria-live="polite" hidden></p>

      <main class="app__main">
        <section class="hauls-list" id="hauls-list" aria-live="polite"></section>
      </main>

      <button type="button" id="floating-create" class="fab" aria-label="Создать рейс">
        +
      </button>
      <section class="editor" id="editor-panel" aria-labelledby="editor-title" aria-hidden="true" hidden>
        <header class="editor__header">
          <div class="editor__header-info">
            <p class="editor__deal-title" id="editor-deal-title">Сделка</p>
            <p class="editor__deal-meta" id="editor-deal-meta"></p>
          </div>
          <div class="editor__header-actions">
            <button type="button" class="button button--ghost" id="close-editor">Закрыть</button>
          </div>
        </header>
        <form id="haul-form" novalidate>
          <div class="form-group">
            <h3>Основная информация</h3>
            <div class="field-grid">
              <label>
                <span>Водитель <small>(обязательно)</small></span>
                <select name="responsible_id" id="driver-select" required></select>
                <span class="hint">Список из отдела «Водители» в Bitrix24</span>
              </label>
              <label>
                <span>Самосвал <small>(обязательно)</small></span>
                <select name="truck_id" id="truck-select" required></select>
              </label>
              <label>
                <span>Материал <small>(обязательно)</small></span>
                <select name="material_id" id="material-select" required></select>
              </label>
              <label>
                <span>Объём, м³</span>
                <input type="number" step="0.01" min="0" name="load_volume" placeholder="0.00" inputmode="decimal" />
              </label>
              <label>
                <span>Плечо, км</span>
                <input
                  type="number"
                  step="0.1"
                  min="0"
                  name="leg_distance_km"
                  id="leg-distance-input"
                  placeholder="0.0"
                  inputmode="decimal"
                />
              </label>
              <label>
                <span>Статус</span>
                <select name="status" id="status-select">
                  <option value="0">Формирование рейса</option>
                  <option value="1">В работе</option>
                  <option value="2">Загрузился</option>
                  <option value="3">Выгрузился</option>
                  <option value="4">Проверено</option>
                </select>
              </label>
            </div>
            <label>
              <span>Заметки по рейсу</span>
              <textarea name="general_notes" rows="3" placeholder="Дополнительная информация для водителя"></textarea>
            </label>
          </div>

          <div class="form-group">
            <h3>Загрузка</h3>
            <div class="field-grid field-grid--two">
              <label>
                <span>Адрес <small>(обязательно)</small></span>
                <textarea name="load_address_text" rows="2" required placeholder="Город, улица, точка GPS"></textarea>
              </label>
              <label>
                <span>Ссылка на карту</span>
                <input type="url" name="load_address_url" placeholder="https://yandex.ru/maps/..." />
              </label>
              <label>
                <span>От кого (поставщик)</span>
                <select name="load_from_company_id" id="supplier-select"></select>
              </label>
              <label>
                <span>Кому (перевозчик)</span>
                <select name="load_to_company_id" id="carrier-select"></select>
              </label>
            </div>
          </div>

          <div class="form-group">
            <h3>Выгрузка</h3>
            <div class="field-grid field-grid--two">
              <label>
                <span>Адрес <small>(обязательно)</small></span>
                <textarea name="unload_address_text" rows="2" required placeholder="Город, улица, точка GPS"></textarea>
              </label>
              <label>
                <span>Ссылка на карту</span>
                <input type="url" name="unload_address_url" placeholder="https://yandex.ru/maps/..." />
              </label>
              <label class="linked-field">
                <span>От кого</span>
                <input type="text" id="unload-from-display" placeholder="Автозаполняется" disabled />
                <input type="hidden" name="unload_from_company_id" id="unload-from-input" />
                <span class="hint">Синхронизируется с выбранным перевозчиком в блоке погрузки.</span>
              </label>
              <label class="linked-field">
                <span>Кому</span>
                <input type="text" id="unload-to-display" placeholder="Клиент сделки" disabled />
                <input type="hidden" name="unload_to_company_id" id="unload-to-input" />
                <span class="hint">Подтягиваем клиента из сделки автоматически.</span>
              </label>
              <label>
                <span>Контактное лицо</span>
                <input type="text" name="unload_contact_name" placeholder="Имя или должность" maxlength="160" />
              </label>
              <label>
                <span>Телефон</span>
                <input type="tel" name="unload_contact_phone" placeholder="+7 900 000-00-00" maxlength="40" />
              </label>
              <label>
                <span>Время приёмки</span>
                <input type="text" name="unload_acceptance_time" placeholder="Например, с 11:00 до 19:00" />
              </label>
            </div>
          </div>

          <footer class="editor__footer">
            <span class="form-error" id="form-error" role="alert"></span>
            <div class="editor__footer-actions">
              <button type="button" class="button button--ghost" id="cancel-editor">Отмена</button>
              <button type="submit" class="button button--primary" id="submit-haul">
                Сохранить
              </button>
            </div>
          </footer>
        </form>
      </section>
    </div>

    <script src="../assets/hauls.js" type="module"></script>
    <script>
      window.B24_HAULS_WIDGET = true;
    </script>
  </body>
</html>
